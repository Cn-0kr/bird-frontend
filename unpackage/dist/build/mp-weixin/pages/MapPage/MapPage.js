"use strict";const e=require("../../common/vendor.js");Math||t();const t=()=>"../../components/tabbar.js",i={__name:"MapPage",setup(t){const i=e.ref(31.2304),a=e.ref(121.4737),o=e.ref(14),n=e.ref(""),s=e.ref([]),l=e.ref([]),c=e.ref(!1),r=e.ref({}),d=[{id:1,name:"嘉定紫藤园",category:"湿地公园",latitude:31.2354,longitude:121.4617,image:"/static/images/location_1.png",description:"嘉定紫藤园是上海市著名的观鸟地点，拥有丰富的湿地生态系统。这里常年有20多种水鸟栖息，是观测候鸟迁徙的绝佳地点。园内有专门的观鸟平台，每年春秋两季是最佳观鸟时间。",birdStats:{species:42,observations:186,rareSpecies:3}},{id:2,name:"新城公园",category:"城市公园",latitude:31.2404,longitude:121.4837,image:"/static/images/location2.jpg",description:"新城公园是市区内难得的鸟类栖息地，公园内有多种乔木和灌木，为小型鸟类提供了良好的栖息环境。这里常见麻雀、白头鹎、黑尾蜡嘴雀等鸟类，是城市中轻松观鸟的好去处。",birdStats:{species:18,observations:94,rareSpecies:0}},{id:3,name:"环城河绿带",category:"河道湿地",latitude:31.2284,longitude:121.4527,image:"/static/images/location3.jpg",description:"环城河绿带沿线栽种了大量水生植物，吸引了多种水鸟前来觅食和栖息。河边设有多个观鸟点，常见鸟类包括白鹭、夜鹭、绿头鸭等。这里环境幽静，是观鸟爱好者的秘密天堂。",birdStats:{species:26,observations:132,rareSpecies:1}},{id:4,name:"嘉宝花园别墅",category:"居民区",latitude:31.2234,longitude:121.4637,image:"/static/images/location4.jpg",description:"嘉宝花园别墅区内绿化良好，种植了多种果树和花卉，吸引了很多小型鸟类前来筑巢。这里可以观察到柳莺、绣眼鸟等小型鸟类，是城市观鸟的好去处。此处为居民区，参观时请保持安静。",birdStats:{species:13,observations:67,rareSpecies:0}},{id:5,name:"梦花湖",category:"湖泊湿地",latitude:31.2454,longitude:121.4557,image:"/static/images/location5.jpg",description:"梦花湖是一个人工湖泊，周围植被茂盛，湖面开阔，是多种水鸟和涉禽的栖息地。这里可以观察到白鹭、苍鹭、小䴙䴘等水鸟，以及多种雁鸭类。湖边有专门的观鸟屋和栈道，适合长时间观鸟。",birdStats:{species:35,observations:158,rareSpecies:2}},{id:6,name:"垃圾填埋场湿地",category:"恢复性湿地",latitude:31.2194,longitude:121.4867,image:"/static/images/location6.jpg",description:"这个区域原是垃圾填埋场，后经过生态修复，现已成为重要的鸟类栖息地。由于昆虫和小型动物丰富，吸引了大量猛禽和涉禽。这里常见猛禽包括红隼、普通鵟等，是观察猛禽的理想场所。",birdStats:{species:22,observations:76,rareSpecies:2}},{id:7,name:"绿地嘉尚国际广场",category:"城市绿地",latitude:31.2284,longitude:121.4987,image:"/static/images/location7.jpg",description:"绿地嘉尚国际广场周边有精心设计的城市绿地，种植了多种乡土树种，为鸟类提供了良好的栖息环境。这里常见鸟类包括珠颈斑鸠、树麻雀、白头鹎等，适合早晨或傍晚前来观鸟。",birdStats:{species:16,observations:83,rareSpecies:0}}],u=()=>{e.index.showLoading({title:"定位中..."}),new Promise(((t,i)=>{e.index.getSetting({success:a=>{!1===a.authSetting["scope.userLocation"]?e.index.showModal({title:"需要位置权限",content:'为了提供准确的地图服务，需要获取您的位置信息。请在设置中允许"云雀解码"访问您的位置。',confirmText:"去设置",cancelText:"取消",success:a=>{a.confirm?e.index.openSetting({success:e=>{e.authSetting["scope.userLocation"]?t():i(new Error("未获得位置权限"))}}):i(new Error("用户取消授权"))}}):!0===a.authSetting["scope.userLocation"]?t():e.index.authorize({scope:"scope.userLocation",success:()=>{t()},fail:e=>{i(e)}})},fail:e=>{i(e)}})})).then((()=>{e.index.getLocation({type:"gcj02",success:t=>{i.value=t.latitude,a.value=t.longitude,o.value=16,e.index.showToast({title:"定位成功",icon:"success",duration:1500}),v()},fail:t=>{console.error("获取位置失败：",t),e.index.showToast({title:"获取位置失败",icon:"none"}),v()},complete:()=>{e.index.hideLoading()}})})).catch((t=>{console.error("位置权限错误：",t),e.index.hideLoading(),v()}))},g=()=>{u()},p=async()=>{if(n.value){e.index.showLoading({title:"搜索中..."});try{const l=await(t=n.value,new Promise(((o,n)=>{e.index.request({url:"https://apis.map.qq.com/ws/place/v1/search",method:"GET",data:{key:"2VEBZ-H2SW5-URJIL-I26ZE-2EB2E-BOF27",keyword:t,boundary:"nearby("+i.value+","+a.value+",10000)",page_size:10,page_index:1},success:e=>{e.data&&0===e.data.status&&e.data.data.length>0?o(e.data.data):n(new Error("未找到相关地点"))},fail:e=>{n(e)}})})));if(l&&l.length>0){i.value=l[0].location.lat,a.value=l[0].location.lng;const e={id:999,latitude:l[0].location.lat,longitude:l[0].location.lng,title:l[0].title,iconPath:"/static/images/location-pin-solid.svg",width:30,height:30,callout:{content:l[0].title,color:"#000000",fontSize:12,borderRadius:5,bgColor:"#ffffff",padding:5,display:"ALWAYS"}},t=s.value.filter((e=>999!==e.id));s.value=[...t,e],o.value=16}}catch(l){e.index.showToast({title:"搜索失败: "+l.message,icon:"none"})}finally{e.index.hideLoading()}var t}},v=()=>{const e=d.map((e=>({id:e.id,latitude:e.latitude,longitude:e.longitude,title:e.name,iconPath:"/static/images/location-pin-solid.svg",width:30,height:30,callout:{content:e.name,color:"#000000",fontSize:12,borderRadius:5,bgColor:"#ffffff",padding:5,display:"AlWAYS"}})));s.value=e,m(d)},m=e=>{if(e.length<3)return;const t=e.map((e=>({latitude:e.latitude,longitude:e.longitude})));t.push(t[0]),l.value=[{points:t,color:"#1E90FF77",width:2,dottedLine:!1,arrowLine:!1}]},f=t=>{console.log("Marker tapped:",t);const i=t.detail.markerId;console.log("Looking for location with ID:",i);const a=d.find((e=>e.id===i));a?(console.log("Found location:",a),r.value=a,c.value=!0):(console.log("No matching location found for ID:",i),e.index.showToast({title:"未找到该地点信息",icon:"none"}))};return e.onMounted((()=>{u()})),(t,d)=>e.e({a:e.o(p),b:n.value,c:e.o((e=>n.value=e.detail.value)),d:i.value,e:a.value,f:s.value,g:l.value,h:o.value,i:e.o(f),j:e.o(g),k:c.value},c.value?e.e({l:e.o((e=>c.value=!1)),m:r.value.image,n:e.t(r.value.name),o:e.t(r.value.category),p:e.t(r.value.description),q:r.value.birdStats},r.value.birdStats?{r:e.t(r.value.birdStats.species),s:e.t(r.value.birdStats.observations),t:e.t(r.value.birdStats.rareSpecies)}:{},{v:e.o((e=>c.value=!1))}):{},{w:c.value},c.value?{x:e.o((e=>c.value=!1))}:{})}};wx.createPage(i);
