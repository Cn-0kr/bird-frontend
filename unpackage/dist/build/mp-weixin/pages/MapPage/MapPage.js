"use strict";const e=require("../../common/vendor.js");Math||a();const a=()=>"../../components/tabbar.js",t={__name:"MapPage",setup(a){const t="https://birdfront-oss.oss-cn-shanghai.aliyuncs.com",i=(e,a="medium")=>{if(!e)return"";const i=e.startsWith("/")?e.slice(1):e;let o="";switch(a){case"icon":o="?x-oss-process=image/resize,m_lfit,w_32,h_32/quality,q_90/format,webp";break;case"small":o="?x-oss-process=image/resize,m_lfit,w_100,h_100/quality,q_90/format,webp";break;case"medium":default:o="?x-oss-process=image/resize,m_lfit,w_200,h_150/quality,q_90/format,webp";break;case"large":o="?x-oss-process=image/resize,m_lfit,w_400,h_250/quality,q_90/format,webp";break;case"marker":o="?x-oss-process=image/resize,m_lfit,w_40,h_40/quality,q_90/format,webp"}return`${t}/${i}${o}`},o=e.ref(31.2304),n=e.ref(121.4737),s=e.ref(14),r=e.ref(""),l=e.ref([]),c=e.ref([]),d=e.ref(!1),u=e.ref({}),m=e.ref(!1),g=e.ref("加载中..."),v=e.ref(!1),p=e.ref("standard"),h=e.ref([{id:1,name:"嘉定紫藤园",category:"湿地公园",latitude:31.2354,longitude:121.4617,image:"static/images/locations/jiading-wisteria.jpg",description:"嘉定紫藤园是上海市著名的观鸟地点，拥有丰富的湿地生态系统。这里常年有20多种水鸟栖息，是观测候鸟迁徙的绝佳地点。园内有专门的观鸟平台，每年春秋两季是最佳观鸟时间。",birdStats:{species:42,observations:186,rareSpecies:3},bestTime:"春秋两季（3-5月，9-11月）清晨5-8点，傍晚4-6点",commonBirds:[{id:1,name:"白鹭"},{id:2,name:"夜鹭"},{id:3,name:"小䴙䴘"},{id:4,name:"绿头鸭"}],markerIcon:"static/icons/marker-wetland.png"},{id:2,name:"新城公园",category:"城市公园",latitude:31.2404,longitude:121.4837,image:"static/images/locations/xincheng-park.jpg",description:"新城公园是市区内难得的鸟类栖息地，公园内有多种乔木和灌木，为小型鸟类提供了良好的栖息环境。这里常见麻雀、白头鹎、黑尾蜡嘴雀等鸟类，是城市中轻松观鸟的好去处。",birdStats:{species:18,observations:94,rareSpecies:0},bestTime:"全年适宜，早晨6-9点最佳",commonBirds:[{id:5,name:"白头鹎"},{id:6,name:"麻雀"},{id:7,name:"乌鸫"},{id:8,name:"珠颈斑鸠"}],markerIcon:"static/icons/marker-park.png"},{id:3,name:"环城河绿带",category:"河道湿地",latitude:31.2284,longitude:121.4527,image:"static/images/locations/huancheng-river.jpg",description:"环城河绿带沿线栽种了大量水生植物，吸引了多种水鸟前来觅食和栖息。河边设有多个观鸟点，常见鸟类包括白鹭、夜鹭、绿头鸭等。这里环境幽静，是观鸟爱好者的秘密天堂。",birdStats:{species:26,observations:132,rareSpecies:1},bestTime:"春夏季节（4-8月）早晚时分",commonBirds:[{id:9,name:"白鹭"},{id:10,name:"绿头鸭"},{id:11,name:"翠鸟"},{id:12,name:"黑水鸡"}],markerIcon:"static/icons/marker-river.png"},{id:4,name:"嘉宝花园别墅",category:"居民区",latitude:31.2234,longitude:121.4637,image:"static/images/locations/jiabao-garden.jpg",description:"嘉宝花园别墅区内绿化良好，种植了多种果树和花卉，吸引了很多小型鸟类前来筑巢。这里可以观察到柳莺、绣眼鸟等小型鸟类，是城市观鸟的好去处。此处为居民区，参观时请保持安静。",birdStats:{species:13,observations:67,rareSpecies:0},bestTime:"春季（3-5月）清晨时分",commonBirds:[{id:13,name:"柳莺"},{id:14,name:"绣眼鸟"},{id:15,name:"红嘴蓝鹊"},{id:16,name:"白头鹎"}],markerIcon:"static/icons/marker-residential.png"},{id:5,name:"梦花湖",category:"湖泊湿地",latitude:31.2454,longitude:121.4557,image:"static/images/locations/menghua-lake.jpg",description:"梦花湖是一个人工湖泊，周围植被茂盛，湖面开阔，是多种水鸟和涉禽的栖息地。这里可以观察到白鹭、苍鹭、小䴙䴘等水鸟，以及多种雁鸭类。湖边有专门的观鸟屋和栈道，适合长时间观鸟。",birdStats:{species:35,observations:158,rareSpecies:2},bestTime:"全年适宜，迁徙季节（春秋）最佳",commonBirds:[{id:17,name:"苍鹭"},{id:18,name:"小䴙䴘"},{id:19,name:"赤膀鸭"},{id:20,name:"白骨顶"}],markerIcon:"static/icons/marker-wetland.png"},{id:6,name:"垃圾填埋场湿地",category:"恢复性湿地",latitude:31.2194,longitude:121.4867,image:"static/images/locations/landfill-wetland.jpg",description:"这个区域原是垃圾填埋场，后经过生态修复，现已成为重要的鸟类栖息地。由于昆虫和小型动物丰富，吸引了大量猛禽和涉禽。这里常见猛禽包括红隼、普通鵟等，是观察猛禽的理想场所。",birdStats:{species:22,observations:76,rareSpecies:2},bestTime:"秋冬季节（10-2月）中午时分",commonBirds:[{id:21,name:"红隼"},{id:22,name:"普通鵟"},{id:23,name:"灰伯劳"},{id:24,name:"田鹨"}],markerIcon:"static/icons/marker-wetland.png"},{id:7,name:"绿地嘉尚国际广场",category:"城市绿地",latitude:31.2284,longitude:121.4987,image:"static/images/locations/jiashang-plaza.jpg",description:"绿地嘉尚国际广场周边有精心设计的城市绿地，种植了多种乡土树种，为鸟类提供了良好的栖息环境。这里常见鸟类包括珠颈斑鸠、树麻雀、白头鹎等，适合早晨或傍晚前来观鸟。",birdStats:{species:16,observations:83,rareSpecies:0},bestTime:"全年适宜，早晨和傍晚最佳",commonBirds:[{id:25,name:"珠颈斑鸠"},{id:26,name:"树麻雀"},{id:27,name:"白头鹎"},{id:28,name:"八哥"}],markerIcon:"static/icons/marker-park.png"}]);e.computed((()=>h.value.reduce(((e,a)=>e+a.birdStats.species),0))),e.computed((()=>h.value.reduce(((e,a)=>e+a.birdStats.observations),0)));const f=()=>{m.value=!0,g.value="定位中...",new Promise(((a,t)=>{e.index.getSetting({success:i=>{!1===i.authSetting["scope.userLocation"]?e.index.showModal({title:"需要位置权限",content:'为了提供准确的地图服务，需要获取您的位置信息。请在设置中允许"云雀解码"访问您的位置。',confirmText:"去设置",cancelText:"取消",success:i=>{i.confirm?e.index.openSetting({success:e=>{e.authSetting["scope.userLocation"]?a():t(new Error("未获得位置权限"))}}):t(new Error("用户取消授权"))}}):!0===i.authSetting["scope.userLocation"]?a():e.index.authorize({scope:"scope.userLocation",success:()=>{a()},fail:e=>{t(e)}})},fail:e=>{t(e)}})})).then((()=>{e.index.getLocation({type:"gcj02",success:a=>{o.value=a.latitude,n.value=a.longitude,s.value=16,e.index.showToast({title:"定位成功",icon:"success",duration:1500}),_()},fail:a=>{console.error("获取位置失败：",a),e.index.showToast({title:"获取位置失败",icon:"none"}),_()},complete:()=>{m.value=!1}})})).catch((e=>{console.error("位置权限错误：",e),m.value=!1,_()}))},b=()=>{try{e.index.vibrateShort({type:"light"})}catch(a){console.warn("触觉反馈不支持:",a)}f()},w=async()=>{if(r.value.trim()){m.value=!0,g.value="搜索中...";try{e.index.vibrateShort({type:"light"})}catch(t){console.warn("触觉反馈不支持:",t)}try{const t=h.value.filter((e=>e.name.includes(r.value)||e.category.includes(r.value)||e.description.includes(r.value)||e.commonBirds.some((e=>e.name.includes(r.value)))));if(t.length>0){const a=t[0];o.value=a.latitude,n.value=a.longitude,s.value=16,y(t),e.index.showToast({title:`找到${t.length}个相关地点`,icon:"success"})}else{const t=await(a=r.value,new Promise(((t,i)=>{e.index.request({url:"https://apis.map.qq.com/ws/place/v1/search",method:"GET",data:{key:"2VEBZ-H2SW5-URJIL-I26ZE-2EB2E-BOF27",keyword:a,boundary:"nearby("+o.value+","+n.value+",10000)",page_size:10,page_index:1},success:e=>{e.data&&0===e.data.status&&e.data.data.length>0?t(e.data.data):i(new Error("未找到相关地点"))},fail:e=>{i(e)}})})));if(t&&t.length>0){o.value=t[0].location.lat,n.value=t[0].location.lng;const a={id:999,latitude:t[0].location.lat,longitude:t[0].location.lng,title:t[0].title,iconPath:i("static/icons/marker-search.png","marker"),width:40,height:40,callout:{content:t[0].title,color:"#000000",fontSize:12,borderRadius:5,bgColor:"#ffffff",padding:5,display:"ALWAYS"}},r=l.value.filter((e=>999!==e.id));l.value=[...r,a],s.value=16,e.index.showToast({title:"搜索成功",icon:"success"})}}}catch(t){console.error("搜索失败:",t),e.index.showToast({title:"搜索失败: "+t.message,icon:"none"})}finally{m.value=!1}var a}else e.index.showToast({title:"请输入搜索内容",icon:"none"})},y=e=>{l.value=h.value.map((a=>{const t=e.some((e=>e.id===a.id));return{id:a.id,latitude:a.latitude,longitude:a.longitude,title:a.name,iconPath:i(t?"static/icons/marker-highlighted.png":a.markerIcon,"marker"),width:t?50:40,height:t?50:40,callout:{content:a.name,color:t?"#ff6b6b":"#000000",fontSize:t?14:12,borderRadius:5,bgColor:t?"#fff5f5":"#ffffff",padding:5,display:"ALWAYS"}}}))},S=()=>{if(s.value<20){s.value+=2;try{e.index.vibrateShort({type:"light"})}catch(a){console.warn("触觉反馈不支持:",a)}}},x=()=>{if(s.value>5){s.value-=2;try{e.index.vibrateShort({type:"light"})}catch(a){console.warn("触觉反馈不支持:",a)}}},k=()=>{p.value="standard"===p.value?"satellite":"standard";try{e.index.vibrateShort({type:"medium"})}catch(a){console.warn("触觉反馈不支持:",a)}e.index.showToast({title:"standard"===p.value?"标准地图":"卫星地图",icon:"none",duration:1e3})},T=e=>{"end"===e.type&&console.log("地图区域变化:",e)},_=()=>{m.value=!0,g.value="加载观测点数据...";try{setTimeout((()=>{const a=h.value.map((e=>({id:e.id,latitude:e.latitude,longitude:e.longitude,title:e.name,iconPath:i(e.markerIcon,"marker"),width:40,height:40,callout:{content:e.name,color:"#000000",fontSize:12,borderRadius:5,bgColor:"#ffffff",padding:5,display:"ALWAYS"}})));l.value=a,j(h.value),m.value=!1,e.index.showToast({title:`已加载${h.value.length}个观测点`,icon:"success",duration:1500})}),800)}catch(a){console.error("加载数据失败:",a),m.value=!1,e.index.showToast({title:"加载数据失败",icon:"none"})}},j=e=>{if(e.length<3)return;const a=e.map((e=>({latitude:e.latitude,longitude:e.longitude})));a.push(a[0]),c.value=[{points:a,color:"#1E90FF77",width:2,dottedLine:!1,arrowLine:!1}]},q=a=>{console.log("Marker tapped:",a);const t=a.detail.markerId;try{e.index.vibrateShort({type:"medium"})}catch(o){console.warn("触觉反馈不支持:",o)}const i=h.value.find((e=>e.id===t));i?(u.value=i,d.value=!0,console.log("显示地点信息:",i.name)):(console.log("未找到匹配的地点信息, ID:",t),e.index.showToast({title:"未找到该地点信息",icon:"none"}))},B=()=>{d.value=!1,u.value={};try{e.index.vibrateShort({type:"light"})}catch(a){console.warn("触觉反馈不支持:",a)}},L=()=>{console.log("查看详情:",u.value.name);try{e.index.vibrateShort({type:"medium"})}catch(a){console.warn("触觉反馈不支持:",a)}e.index.navigateTo({url:`/pages/LocationDetail/LocationDetail?id=${u.value.id}`,fail:a=>{console.error("跳转失败:",a),e.index.showToast({title:"功能开发中",icon:"none"})}})},I=()=>{const a=u.value;console.log("导航到:",a.name);try{e.index.vibrateShort({type:"heavy"})}catch(t){console.warn("触觉反馈不支持:",t)}e.index.openLocation({latitude:a.latitude,longitude:a.longitude,name:a.name,address:a.description,success:()=>{console.log("成功打开地图导航")},fail:a=>{console.error("打开地图失败:",a),e.index.showToast({title:"无法打开导航",icon:"none"})}})},z=()=>{const a=u.value;console.log("分享地点:",a.name);try{e.index.vibrateShort({type:"medium"})}catch(t){console.warn("触觉反馈不支持:",t)}e.index.share({provider:"weixin",scene:"WXSceneSession",type:0,href:`https://yourapp.com/location/${a.id}`,title:`${a.name} - 观鸟地点推荐`,summary:a.description,imageUrl:i(a.image,"medium"),success:()=>{e.index.showToast({title:"分享成功",icon:"success"}),B()},fail:a=>{console.error("分享失败:",a),e.index.showToast({title:"分享失败",icon:"none"})}})},E=e=>{console.warn("图标加载失败:",e),e.target&&(e.target.style.display="none")},P=e=>{if(console.warn("地点图片加载失败:",e),e.target){const a=i("static/images/location-placeholder.jpg","large");e.target.src=a}};return e.onMounted((()=>{console.log("地图页面已加载"),f(),setTimeout((()=>{v.value=!0,setTimeout((()=>{v.value=!1}),5e3)}),2e3)})),(a,t)=>e.e({a:e.o(w),b:r.value,c:e.o((e=>r.value=e.detail.value)),d:r.value},r.value?{e:e.o(w)}:{},{f:o.value,g:n.value,h:l.value,i:c.value,j:s.value,k:e.o(q),l:e.o(T),m:e.o(b),n:e.o(S),o:e.o(x),p:e.o(k),q:d.value},d.value?e.e({r:e.o(B),s:i(u.value.image,"large"),t:e.o(P),v:e.t(u.value.category),w:e.t(u.value.name),x:e.t(u.value.description),y:u.value.birdStats},u.value.birdStats?{z:e.t(u.value.birdStats.species),A:e.t(u.value.birdStats.observations),B:e.t(u.value.birdStats.rareSpecies)}:{},{C:u.value.bestTime},u.value.bestTime?{D:e.t(u.value.bestTime)}:{},{E:u.value.commonBirds},u.value.commonBirds?{F:e.f(u.value.commonBirds,((a,t,i)=>({a:e.t(a.name),b:a.id})))}:{},{G:e.o(L),H:e.o(I),I:e.o(z),J:e.o((()=>{})),K:e.o(B)}):{},{L:m.value},m.value?{M:e.t(g.value)}:{},{N:v.value},v.value?{O:e.o((e=>v.value=!1)),P:i("static/icons/marker-wetland.png","icon"),Q:e.o(E),R:i("static/icons/marker-park.png","icon"),S:e.o(E),T:i("static/icons/marker-river.png","icon"),U:e.o(E),V:i("static/icons/marker-residential.png","icon"),W:e.o(E)}:{})}};wx.createPage(t);
